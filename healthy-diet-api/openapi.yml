openapi: 3.0.0

info:
  title: Healthy Diet API
  version: 1.0.0
  description: |
    健康飲食的 RESTful API 服務。提供完整的使用者認證、飲食記錄管理、營養分析及
    個人化建議功能端點。

servers:
  - url: http://localhost:3000/api
    description: 本地開發伺服器
  # TODO: 添加生產伺服器連結 URL

tags:
  - name: Authentication
    description: 使用者認證與 Session 管理操作，包括註冊、登入及基於 Token 的授權機制。
  - name: Users
    description: 使用者個人資料與帳戶管理端點，用於擷取與更新使用者資訊及偏好設定。
  - name: Diet Records
    description: 建立、擷取、更新與刪除每日飲食攝取記錄及餐點條目的操作。
  - name: Nutrition
    description: 基於使用者飲食模式提供營養分析服務與個人化飲食建議。
  - name: System
    description: 系統健康監控與服務可用性端點，用於基礎設施監控與負載平衡。

paths:
  /auth/login:
    post:
      summary: 使用者登入
      description: |
        驗證使用者身分並返回用於後續 API 請求的存取 Token 及使用者資訊。

        客戶端應提交有效的電子郵件及密碼憑證。成功驗證後，回應將包含 JWT Token 及使用者基本資料。
      operationId: login
      tags: [Authentication]
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequestBody"
            examples:
              example:
                value:
                  email: example@example.com
                  password: password
      responses:
        "200":
          description: 驗證成功。返回 JWT Token 與使用者資訊。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
              examples:
                success:
                  summary: 成功登入
                  value:
                    token: eyJhbGciOiJIUzI1Ni..."
                    refreshToken: eyJhbGciOiJIUzI1Ni..."
                    expiresIn: 3600
                    user:
                      id: "550e8400-e29b-41d4-a716-446655440000"
                      email: "example@example.com"
                      nickname: "HealthyUser"
                      avatarUrl: null

  /auth/register:
    post:
      summary: 使用者註冊
      description: |
        使用提供的憑證建立新的使用者帳戶。註冊成功後，帳戶即可透過登入端點進行驗證。
      operationId: register
      tags: [Authentication]
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequestBody"
            examples:
              example:
                value:
                  email: example@example.com
                  password: password
                  nickname: "NewUser"
      responses:
        "200":
          description: 使用者帳戶建立成功。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"

  /auth/refresh:
    post:
      summary: 更新存取 Token
      description: |
        使用有效的更新 Token 產生新的存取 Token。
      operationId: refreshToken
      tags: [Authentication]
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshTokenRequestBody"
            examples:
              example:
                value:
                  refreshToken: eyJhbGciOiJIUzI1Ni..."
      responses:
        "200":
          description: Token 更新成功。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "401":
          description: 無效或已過期的更新 Token。

  /health:
    get:
      summary: API 健康檢查
      description: 返回 API 服務目前的運作狀態。
      operationId: checkHealth
      tags: [System]
      responses:
        "200":
          description: 服務正常運作。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SystemHealthResponse"
              examples:
                healthy:
                  value:
                    status: ok
                    time: "2025-12-23T10:30:00.000Z"
                    uptime: 86400
  /api/user/profile:
    get:
      summary: 取得個人詳細資料
      description: 取得使用者的基本資料、身體數值以及最近的 AI 諮詢紀錄。
      operationId: getProfile
      tags: [Users]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: 成功取得資料
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserDetailResponse"
        "401":
          description: 未授權 (Token 無效或過期)

    put:
      summary: 更新個人資料
      description: 更新使用者的暱稱、身高、體重或飲食禁忌。支援部分更新 (Partial Update)。
      operationId: updateProfile
      tags: [Users]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateProfilePayload"
      responses:
        "200":
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserDetailResponse"
        "400":
          description: 資料格式錯誤                 

components:
  schemas:
    UserProfile:
      type: object
      required:
        - id
        - email
      properties:
        id:
          type: string
          format: uuid
          description: 使用者唯一識別碼 (UUID)
        email:
          type: string
          format: email
        nickname:
          type: string
          nullable: true
          description: 使用者暱稱
        avatarUrl:
          type: string
          nullable: true
          description: 頭像圖片連結 (對應 Rust 的 avatar_url，JSON 欄位為 avatarUrl)

    LoginRequestBody:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: example@example.com
        password:
          type: string
          format: password
          example: password

    RegisterRequestBody:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: example@example.com
        password:
          type: string
          format: password
          example: password
        nickname:
          type: string
          nullable: true
          description: (選填) 使用者暱稱
          example: HealthyUser
        avatarUrl:
          type: string
          nullable: true
          description: (選填) 頭像 URL
          example: https://example.com/avatar.jpg

    RefreshTokenRequestBody:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string
          example: eyJhbGciOiJIUzI1Ni..."

    AuthResponse:
      type: object
      required:
        - token
        - refreshToken
        - expiresIn
        - user
      properties:
        token:
          type: string
          description: JWT Access Token
        refreshToken:
          type: string
          description: Refresh Token
        expiresIn:
          type: integer
          description: Token 有效秒數
        user:
          $ref: "#/components/schemas/UserProfile"

    SystemHealthResponse:
      type: object
      required:
        - status
        - time
        - uptime
      properties:
        status:
          type: string
          enum: [ok, degraded, fail]
        time:
          type: string
          format: date-time
        uptime:
          type: number
    UpdateProfilePayload:
      type: object
      properties:
        nickname:
          type: string
          nullable: true
          example: "FitnessGuru"
        height:
          type: number
          format: double
          nullable: true
          description: 身高 (cm)
          example: 175.5
        weight:
          type: number
          format: double
          nullable: true
          description: 體重 (kg)
          example: 68.0
        dietary_restrictions:
          type: string
          nullable: true
          description: 飲食禁忌或過敏源
          example: "不吃花生, 素食"

    
    AiConsultationRecord:
      type: object
      required:
        - id
        - question
        - aiResponse
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        question:
          type: string
          description: 使用者問的問題
          example: "我想減肥該吃什麼？"
        aiResponse: 
          type: string
          description: AI 的回答
          example: "建議多攝取蛋白質..."
        createdAt:  
          type: string
          format: date-time
          example: "2025-12-25T14:30:00Z"

    UserDetailResponse:
      allOf:
        - $ref: "#/components/schemas/UserProfile" 
        - type: object
          properties:
            height:
              type: number
              nullable: true
            weight:
              type: number
              nullable: true
            dietaryRestrictions: 
              type: string
              nullable: true
            aiConsultations:    
              type: array
              items:
                $ref: "#/components/schemas/AiConsultationRecord"

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - bearerAuth: []